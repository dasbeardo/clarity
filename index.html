<!--
  Clarity - A Text-Based Polyphonic Synthesizer

  Clarity is an innovative browser-based synthesizer that allows musicians and sound designers to
  create and manipulate audio using a text-driven interface. Rather than clicking through traditional
  knobs and sliders, users define their instrument by editing a structured text document that
  dynamically generates the user interface.

  The application features a split-pane design: the left pane contains a custom block-based text
  editor with syntax highlighting, while the right pane displays dynamically generated controls that
  update in real-time as you type. Users can create multiple oscillators with customizable parameters
  including waveform type (sine, square, sawtooth, triangle), octave offset, and volume. Each
  oscillator supports individual ADSR envelope controls for attack time, sustain level, and release time.

  Built on the Web Audio API, Clarity provides true polyphonic playback with a sophisticated
  polyphony manager that tracks multiple simultaneous notes. The synthesizer includes a master
  compressor with adjustable threshold, ratio, knee, attack, and release parameters to prevent
  clipping and shape the overall sound. Input methods include MIDI controller support and a virtual
  keyboard mapped to your computer keyboard. The interface features keyboard shortcuts for
  incrementing/decrementing values, adjusting text size and line spacing, and a command palette
  accessible via slash commands for quick actions.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>clarity</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hammersmith+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- Left Pane: Text Editor -->
    <div class="left-pane">
      <div class="pane-header">
        <span class="header-title">clarity</span>
        <div class="editor-tabs">
          <button class="tab active" data-tab="synth">.instrument</button>
          <button class="tab" data-tab="sequencer">.sequence</button>
        </div>
        <div class="header-spacer"></div>
        <div class="sequencer-transport-header" id="sequencer-transport-header">
          <span class="transport-label">seq</span>
          <button id="seq-play-header" class="transport-btn play-btn" title="Play/Pause Sequencer">▶</button>
          <button id="seq-stop-header" class="transport-btn stop-btn" title="Stop Sequencer">■</button>
        </div>
        <button id="help-btn" class="header-help-btn" title="Help">?</button>
      </div>
      <div id="parameters" class="tab-content"></div>
      <div id="sequencer-editor" class="tab-content hidden"></div>
    </div>

    <!-- Right Pane: Controls -->
    <div class="right-pane">
      <!-- Note Display (shown during keyboard/MIDI input) -->
      <div id="note-display" class="note-display">
        <span id="note-display-text">--</span>
      </div>

      <!-- Track Visualizer (shown during sequencer playback) -->
      <div id="track-visualizer" class="track-visualizer" style="display: none;">
        <!-- Dynamically populated with track indicators -->
      </div>


      <!-- Virtual Keyboard Panel -->
      <div class="controls-section keyboard-panel">
        <div id="virtual-keyboard" tabindex="0">
          <div class="keyboard-hint">Click here, then use keyboard to play</div>
          <div class="keyboard-layout">
            <div class="keyboard-row">
              <span class="key-label" data-key="1">1</span>
              <span class="key-label" data-key="2">2</span>
              <span class="key-label" data-key="3">3</span>
              <span class="key-label" data-key="4">4</span>
              <span class="key-label" data-key="5">5</span>
              <span class="key-label" data-key="6">6</span>
              <span class="key-label" data-key="7">7</span>
              <span class="key-label" data-key="8">8</span>
              <span class="key-label" data-key="9">9</span>
              <span class="key-label" data-key="0">0</span>
            </div>
            <div class="keyboard-row">
              <span class="key-label" data-key="q">Q</span>
              <span class="key-label" data-key="w">W</span>
              <span class="key-label" data-key="e">E</span>
              <span class="key-label" data-key="r">R</span>
              <span class="key-label" data-key="t">T</span>
              <span class="key-label" data-key="y">Y</span>
              <span class="key-label" data-key="u">U</span>
              <span class="key-label" data-key="i">I</span>
              <span class="key-label" data-key="o">O</span>
              <span class="key-label" data-key="p">P</span>
            </div>
            <div class="keyboard-row">
              <span class="key-label" data-key="a">A</span>
              <span class="key-label" data-key="s">S</span>
              <span class="key-label" data-key="d">D</span>
              <span class="key-label" data-key="f">F</span>
              <span class="key-label" data-key="g">G</span>
              <span class="key-label" data-key="h">H</span>
              <span class="key-label" data-key="j">J</span>
              <span class="key-label" data-key="k">K</span>
              <span class="key-label" data-key="l">L</span>
              <span class="key-label" data-key=";">;</span>
            </div>
            <div class="keyboard-row">
              <span class="key-label" data-key="z">Z</span>
              <span class="key-label" data-key="x">X</span>
              <span class="key-label" data-key="c">C</span>
              <span class="key-label" data-key="v">V</span>
              <span class="key-label" data-key="b">B</span>
              <span class="key-label" data-key="n">N</span>
              <span class="key-label" data-key="m">M</span>
              <span class="key-label" data-key=",">,</span>
              <span class="key-label" data-key=".">.</span>
              <span class="key-label" data-key="/">/</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dynamic oscillator sections generated from text -->
      <div id="oscillators-container"></div>

      <!-- Hidden template sections (kept for backwards compatibility but not used) -->
      <div class="controls-section hidden" id="osc1-section">
        <h2>Oscillator 1</h2>

        <div class="slider-container">
          <label for="osc1-wave">Wave</label>
          <select id="osc1-wave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="sawtooth">Sawtooth</option>
            <option value="triangle">Triangle</option>
          </select>
        </div>

        <div class="slider-container">
          <label for="osc1-octave">Octave</label>
          <input type="range" id="osc1-octave" min="-2" max="2" step="1" value="0">
        </div>

        <div class="slider-container">
          <label for="osc1-volume">Volume</label>
          <input type="range" id="osc1-volume" min="0" max="100" step="1" value="50">
        </div>
      </div>

      <div class="controls-section hidden" id="osc2-section">
        <h2>Oscillator 2</h2>

        <div class="slider-container">
          <label for="osc2-wave">Wave</label>
          <select id="osc2-wave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="sawtooth">Sawtooth</option>
            <option value="triangle">Triangle</option>
          </select>
        </div>

        <div class="slider-container">
          <label for="osc2-octave">Octave</label>
          <input type="range" id="osc2-octave" min="-2" max="2" step="1" value="1">
        </div>

        <div class="slider-container">
          <label for="osc2-volume">Volume</label>
          <input type="range" id="osc2-volume" min="0" max="100" step="1" value="30">
        </div>
      </div>

      <div class="controls-section hidden" id="osc3-section">
        <h2>Oscillator 3</h2>

        <div class="slider-container">
          <label for="osc3-wave">Wave</label>
          <select id="osc3-wave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="sawtooth">Sawtooth</option>
            <option value="triangle">Triangle</option>
          </select>
        </div>

        <div class="slider-container">
          <label for="osc3-octave">Octave</label>
          <input type="range" id="osc3-octave" min="-2" max="2" step="1" value="-1">
        </div>

        <div class="slider-container">
          <label for="osc3-volume">Volume</label>
          <input type="range" id="osc3-volume" min="0" max="100" step="1" value="20">
        </div>
      </div>

      <!-- All UI sections are generated dynamically from the document -->
    </div>
  </div>

  <!-- Command Modal -->
  <div id="command-modal" class="hidden">
    <input type="text" id="command-search" placeholder="Search commands..." autocomplete="off">
    <div id="command-list"></div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="help-modal hidden">
    <div class="help-modal-content">
      <div class="help-modal-header">
        <div class="help-tabs">
          <button class="help-tab active" data-help-tab="instrument">Instrument</button>
          <button class="help-tab" data-help-tab="sequencer">Sequencer</button>
        </div>
        <button class="help-close-btn">&times;</button>
      </div>
      <div class="help-modal-body">
        <!-- Instrument Help -->
        <div id="help-instrument" class="help-content active">
          <h2>Building Instruments</h2>
          <p>Define your sound by writing text. Each component starts with a header, followed by indented parameters.</p>

          <h3>Oscillators</h3>
          <pre>oscillator lead
  wave sawtooth
  octave 0
  volume 60
  attack 10
  decay 200
  sustain 80
  release 400
  pitch vibrato
  distortion crunch
  color cyan</pre>

          <div class="help-table">
            <h4>Wave Types</h4>
            <table>
              <tr><td><code>sine</code></td><td>Pure, clean tone - bass, sub</td></tr>
              <tr><td><code>square</code></td><td>Hollow, retro - leads, chiptune</td></tr>
              <tr><td><code>sawtooth</code></td><td>Bright, buzzy - leads, brass</td></tr>
              <tr><td><code>triangle</code></td><td>Soft, muted - flutes, pads</td></tr>
              <tr><td><code>noise</code></td><td>White noise - drums, textures</td></tr>
            </table>
          </div>

          <div class="help-table">
            <h4>Envelope (ADSR)</h4>
            <table>
              <tr><td><code>attack</code></td><td>Time to reach peak (ms)</td></tr>
              <tr><td><code>decay</code></td><td>Time to fall to sustain (ms)</td></tr>
              <tr><td><code>sustain</code></td><td>Level while held (0-100)</td></tr>
              <tr><td><code>release</code></td><td>Fade out time (ms)</td></tr>
            </table>
          </div>

          <h3>LFO (Vibrato)</h3>
          <pre>lfo vibrato
  wave sine
  rate 5.5
  depth 12</pre>
          <p>Add <code>pitch vibrato</code> to an oscillator to apply it.</p>

          <h3>Distortion</h3>
          <pre>distortion crunch
  drive 50
  mix 70</pre>
          <p>Add <code>distortion crunch</code> to an oscillator or master.</p>

          <h3>Master</h3>
          <pre>master
  volume 75</pre>

          <h3>Tips</h3>
          <ul>
            <li><strong>Kicks:</strong> sine, octave -2, fast attack, short decay, sustain 0</li>
            <li><strong>Snares:</strong> noise, fast attack, medium decay</li>
            <li><strong>Bass:</strong> sawtooth/square, octave -1, high sustain</li>
            <li><strong>Leads:</strong> square/saw, add vibrato LFO, medium attack</li>
            <li><strong>Pads:</strong> triangle/sine, slow attack, long release</li>
          </ul>
        </div>

        <!-- Sequencer Help -->
        <div id="help-sequencer" class="help-content">
          <h2>Writing Sequences</h2>
          <p>Each oscillator can have its own pattern. Steps are space-separated.</p>

          <pre>bpm 120
swing 55

oscillator kick
  sequence c2 - - - c2 - - - c2 - - - c2 - - -

oscillator bass
  sequence c2>e2 e2 - - g2 - - -</pre>

          <h3>Note Syntax</h3>
          <div class="help-table">
            <table>
              <tr><td><code>c4</code></td><td>Note + octave</td></tr>
              <tr><td><code>f#3</code> <code>eb5</code></td><td>Sharps and flats</td></tr>
              <tr><td><code>-</code></td><td>Rest (silence)</td></tr>
            </table>
          </div>

          <h3>Modifiers</h3>
          <div class="help-table">
            <table>
              <tr><td><code>c4@80</code></td><td>Velocity (0-100)</td></tr>
              <tr><td><code>c4:50</code></td><td>Gate/duration (0-100%)</td></tr>
              <tr><td><code>c4~</code></td><td>Tie (hold into next step)</td></tr>
              <tr><td><code>c4@80:50~</code></td><td>Combined</td></tr>
            </table>
          </div>

          <h3>Chords</h3>
          <pre>[c4,e4,g4]              # C major
[c4~,e4~,g4] [c4~,e4~,a4]   # Voice leading</pre>
          <p>Use <code>~</code> on individual notes to hold them while others change.</p>

          <h3>Slides</h3>
          <pre>c4>e4    # Glide from C4 to E4
e2>g2 g2 g2>c3   # Bass slides</pre>
          <p>Slides auto-sustain for smooth pitch glides.</p>

          <h3>Swing</h3>
          <pre>swing 55   # Subtle groove
swing 67   # Heavy triplet feel</pre>
          <p>50 = straight, 67 = full triplet swing.</p>

          <h3>Expression Tips</h3>
          <ul>
            <li><strong>Ghost notes:</strong> <code>c4@30</code> for subtle hits</li>
            <li><strong>Staccato:</strong> <code>c4:25</code> for punchy notes</li>
            <li><strong>Long notes:</strong> <code>c4~ c4~ c4~ c4</code></li>
            <li><strong>Build-up:</strong> <code>c4@50 c4@70 c4@90 c4@100</code></li>
          </ul>

          <h3>Track Colors</h3>
          <p>Add <code>color red</code> (or <code>#ff3300</code>) to oscillators. Indicators light up during playback.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="chords.js"></script>
  <script src="variables.js"></script>
  <!-- New architecture files -->
  <script src="schemas.js"></script>
  <script src="instance-store.js"></script>
  <script src="parser.js"></script>
  <script src="audio-engine.js"></script>
  <script src="ui-generator.js"></script>
  <script src="sequencer.js"></script>
  <!-- Main application script -->
  <script src="script.js"></script>
</body>
</html>
